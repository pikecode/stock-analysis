# è®¤è¯åˆ†ç¦»å®æ–½ - æ–¹æ¡ˆä¸€å®Œæˆ

## å®æ–½æ—¶é—´
2025-11-28

## æ–¹æ¡ˆé€‰æ‹©
**æ–¹æ¡ˆä¸€ï¼šç»Ÿä¸€Token + å¼ºåŒ–è§’è‰²æ£€æŸ¥**
- æ”¹åŠ¨é‡æœ€å°
- å¿«é€Ÿå®ç°
- æŠ€æœ¯ä¸Šå…±äº«tokenï¼Œå®é™…ä½¿ç”¨ä¸­å®Œå…¨éš”ç¦»

---

## å·²å®Œæˆçš„ä»£ç ä¿®æ”¹

### åç«¯ä¿®æ”¹

#### 1. Token Schema (backend/app/schemas/user.py:51)
```python
class Token(BaseModel):
    access_token: str
    refresh_token: str
    token_type: str = "bearer"
    expires_in: int
    role: str  # âœ… æ–°å¢å­—æ®µ
```

#### 2. ç™»å½•æ¥å£è¿”å›role (backend/app/api/auth.py)
- **ç¬¬54-59è¡Œ**ï¼šç™»å½•æ—¶è¿”å› `role=user.role.value`
- **ç¬¬92-97è¡Œ**ï¼šåˆ·æ–°tokenæ—¶ä¹Ÿè¿”å› role

### å‰ç«¯ä¿®æ”¹

#### 3. AdminLogin é¡µé¢ (frontend/src/views/AdminLogin.vue:47-55)
```typescript
if (!authStore.isAdmin) {
  console.error('âŒ ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜')
  ElMessage.error('æ­¤é¡µé¢ä»…é™ç®¡ç†å‘˜è®¿é—®')
  await authStore.logout()
  form.value.username = ''
  form.value.password = ''
  return
}
```

#### 4. Login é¡µé¢ (frontend/src/views/Login.vue:59-68)
```typescript
if (authStore.isAdmin) {
  console.error('âŒ ç®¡ç†å‘˜ç”¨æˆ·ä¸èƒ½è®¿é—®å®¢æˆ·ç«¯')
  ElMessage.error('ç®¡ç†å‘˜ç”¨æˆ·è¯·ä½¿ç”¨ç®¡ç†å‘˜ç™»å½•é¡µé¢')
  await authStore.logout()
  form.username = ''
  form.password = ''
  return
}
```

#### 5. è·¯ç”±å®ˆå« (frontend/src/router/index.ts:280-315)
```typescript
if (!authStore.hasRole(requiredRole)) {
  console.warn(`User does not have required role: ${requiredRole}`)
  // è§’è‰²ä¸åŒ¹é…ï¼Œå¼ºåˆ¶ç™»å‡ºå¹¶é‡å®šå‘åˆ°åˆé€‚çš„ç™»å½•é¡µ
  authStore.logout()
  if (requiredRole === 'admin') {
    next({ name: 'AdminLogin', query: { redirect: to.fullPath } })
  } else {
    next({ name: 'Login', query: { redirect: to.fullPath } })
  }
  return
}
```

---

## è®¤è¯æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·ç™»å½•è¯·æ±‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  POST /login    â”‚
                    â”‚ ç”¨æˆ·å+å¯†ç       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  è¿”å› Token + role      â”‚
                â”‚ {role: "ADMIN"|"VIP"}   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                     â”‚
     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
     â”‚ è®¿é—® /login     â”‚              â”‚ è®¿é—® /admin   â”‚
     â”‚ (å®¢æˆ·ç«¯ç™»å½•)    â”‚              â”‚ (ç®¡ç†å‘˜ç™»å½•)  â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                    â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ£€æŸ¥: isAdmin?    â”‚            â”‚ æ£€æŸ¥: isAdmin?    â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                    â”‚
     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”
     â”‚  YES    â”‚  â”‚ NO  â”‚            â”‚ YES  â”‚ â”‚  â”‚ NO    â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜            â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”˜
          â”‚          â”‚                   â”‚     â”‚      â”‚
    âŒæ‹’ç» âœ…é€šè¿‡      â”‚              âœ…é€šè¿‡   â”‚  âŒæ‹’ç»
    ç™»å‡º   é‡å®šå‘     â”‚              é‡å®šå‘  â”‚  ç™»å‡º
          /reports   â”‚              /admin  â”‚  é‡å®šå‘
                     â”‚                      â”‚  /admin-login
              æç¤ºé”™è¯¯ â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚           â”‚ è·¯ç”±å®ˆå«æ£€æŸ¥è§’è‰²  â”‚
                     â”‚           â”‚ (å¼‚å¸¸è®¿é—®æ—¶)      â”‚
                     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                     â”‚
                     â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚            â”‚ è‹¥è§’è‰²ä¸åŒ¹é…    â”‚
                     â”‚            â”‚ ç™»å‡º+é‡å®šå‘     â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ åˆ°å¯¹åº”ç™»å½•é¡µ   â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æµ‹è¯•ç”¨ä¾‹

### åœºæ™¯1ï¼šAdminç”¨æˆ·å°è¯•ç™»å½•å®¢æˆ·ç«¯é¡µé¢
- è®¿é—® `/login`
- ä½¿ç”¨ admin è´¦å·ç™»å½•
- é¢„æœŸï¼šåº”è¢«æ‹’ç»ï¼Œæ˜¾ç¤º"ç®¡ç†å‘˜ç”¨æˆ·è¯·ä½¿ç”¨ç®¡ç†å‘˜ç™»å½•é¡µé¢"
- è¡¨å•æ¸…ç©ºï¼Œè‡ªåŠ¨ç™»å‡º

### åœºæ™¯2ï¼šCustomerç”¨æˆ·å°è¯•è®¿é—®ç®¡ç†ç«¯
- ç™»å½•å®¢æˆ·ç«¯
- å°è¯•è®¿é—® `/admin/dashboard` æˆ–å…¶ä»–ç®¡ç†é¡µé¢
- é¢„æœŸï¼šåº”è¢«è·¯ç”±å®ˆå«æ‹¦æˆªï¼Œè‡ªåŠ¨ç™»å‡º
- é‡å®šå‘åˆ° `/login`

### åœºæ™¯3ï¼šAdminç”¨æˆ·æ­£å¸¸ç™»å½•ç®¡ç†ç«¯
- è®¿é—® `/admin-login`
- ä½¿ç”¨ admin è´¦å·ç™»å½•
- é¢„æœŸï¼šæˆåŠŸç™»å½•ï¼Œæ˜¾ç¤º"ç™»å½•æˆåŠŸ"
- é‡å®šå‘åˆ° `/admin/dashboard`

### åœºæ™¯4ï¼šCustomerç”¨æˆ·æ­£å¸¸ç™»å½•å®¢æˆ·ç«¯
- è®¿é—® `/login`
- ä½¿ç”¨ customer è´¦å·ç™»å½•
- é¢„æœŸï¼šæˆåŠŸç™»å½•ï¼Œæ˜¾ç¤º"ç™»å½•æˆåŠŸ"
- é‡å®šå‘åˆ° `/reports`

---

## æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—å‚è€ƒ

ç™»å½•æ—¶ä¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼Œå¯åœ¨ F12 â†’ Console æŸ¥çœ‹ï¼š
- ğŸ”µ [AdminLogin] handleLogin è¢«è°ƒç”¨
- ğŸ” æ£€æŸ¥ç”¨æˆ·è§’è‰²ï¼ŒisAdmin: true/false
- âœ… ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼ æˆ– âŒ ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜
- ğŸ“ é‡å®šå‘åˆ°: /admin æˆ– /login

---

## åç»­ä¼˜åŒ–æ–¹å‘ï¼ˆå¯é€‰ï¼‰

1. **Token åŠ å¯†å¢å¼º**ï¼šåœ¨ token payload ä¸­åŠ å…¥ type å­—æ®µæ ‡è®°
2. **API å±‚æ‹¦æˆª**ï¼šåœ¨åç«¯éªŒè¯ token æ—¶æ£€æŸ¥è§’è‰²æ˜¯å¦ä¸æ¥å£åŒ¹é…
3. **åŒtokenç‹¬ç«‹å­˜å‚¨**ï¼ˆæ–¹æ¡ˆäºŒï¼‰ï¼šå¦‚æœåç»­éœ€è¦æ›´ä¸¥æ ¼çš„éš”ç¦»

---

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | è¡Œå· | ä¿®æ”¹å†…å®¹ |
|------|------|--------|
| backend/app/schemas/user.py | 51 | æ·»åŠ  role: str å­—æ®µ |
| backend/app/api/auth.py | 54-59, 92-97 | ç™»å½•å’Œåˆ·æ–°æ—¶è¿”å› role |
| frontend/src/views/AdminLogin.vue | 47-55 | éadminç”¨æˆ·æ‹’ç»ç™»å½• |
| frontend/src/views/Login.vue | 59-68 | adminç”¨æˆ·æ‹’ç»ç™»å½• |
| frontend/src/router/index.ts | 280-315 | å¼ºåŒ–è·¯ç”±å®ˆå«æ£€æŸ¥ |

