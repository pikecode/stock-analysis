# å¤šæŒ‡æ ‡æ•°æ®ç³»ç»Ÿè®¾è®¡

**ç‰ˆæœ¬**: v1.0
**æ—¥æœŸ**: 2025-11-22
**çŠ¶æ€**: æ ¸å¿ƒè®¾è®¡

---

## ğŸ“‹ éœ€æ±‚èƒŒæ™¯

### ç°çŠ¶åˆ†æ

**æ•°æ®æ–‡ä»¶ç±»å‹**:
- `TTV.txt` - æŸç§äº¤æ˜“æŒ‡æ ‡
- `EEE.txt` - å¦ä¸€ç§äº¤æ˜“æŒ‡æ ‡
- `EFV.txt` - æœªæ¥æ–°å¢
- `AAA.txt` - æœªæ¥æ–°å¢
- è¿˜ä¼šæœ‰æ›´å¤š...

**å…³é”®ç‰¹å¾**:
1. âœ… æ¯ç§ç±»å‹éƒ½æ˜¯ç‹¬ç«‹çš„æŒ‡æ ‡
2. âœ… åŒä¸€ç±»å‹å¯ä»¥æœ‰å¤šä¸ªæ–‡ä»¶ï¼ˆä¸åŒæ—¥æœŸï¼‰
3. âœ… æ¯ç§æŒ‡æ ‡æœ‰è‡ªå·±ç‹¬ç«‹çš„æ±‡æ€»é€»è¾‘
4. âœ… éœ€è¦æ”¯æŒåŠ¨æ€æ‰©å±•æ–°æŒ‡æ ‡

### è®¾è®¡ç›®æ ‡

1. **çµæ´»æ€§**: æ”¯æŒä»»æ„å¤šç§æŒ‡æ ‡ç±»å‹
2. **æ‰©å±•æ€§**: æ–°å¢æŒ‡æ ‡ç±»å‹ä¸éœ€è¦ä¿®æ”¹æ•°æ®åº“ç»“æ„
3. **ç‹¬ç«‹æ€§**: æ¯ç§æŒ‡æ ‡çš„æ±‡æ€»é€»è¾‘äº’ä¸å¹²æ‰°
4. **ç»Ÿä¸€æ€§**: æ‰€æœ‰æŒ‡æ ‡ä½¿ç”¨ç»Ÿä¸€çš„å¯¼å…¥å’ŒæŸ¥è¯¢æ¥å£

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 1. æŒ‡æ ‡ç±»å‹æŠ½è±¡

```
æŒ‡æ ‡ç±»å‹ï¼ˆMetric Typeï¼‰
    â†“
åŒ…å«ï¼šåç§°ã€ä»£ç ã€å­—æ®µå®šä¹‰ã€æ±‡æ€»è§„åˆ™
    â†“
å…·ä½“å®ä¾‹ï¼šTTV, EEE, EFV, AAA...
```

### 2. æ•°æ®åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡é…ç½®å±‚ (Metric Configuration)          â”‚
â”‚ - æŒ‡æ ‡ç±»å‹å®šä¹‰                              â”‚
â”‚ - å­—æ®µæ˜ å°„è§„åˆ™                              â”‚
â”‚ - æ±‡æ€»è®¡ç®—è§„åˆ™                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æºæ•°æ®å±‚ (Raw Data)                        â”‚
â”‚ - æ‰€æœ‰æŒ‡æ ‡çš„åŸå§‹æ•°æ®                        â”‚
â”‚ - æŒ‰æŒ‡æ ‡ç±»å‹æ ‡è®°                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¡ç®—ç»“æœå±‚ (Computed Data)                 â”‚
â”‚ - æ¯ç§æŒ‡æ ‡ç‹¬ç«‹çš„æ±‡æ€»ç»“æœ                    â”‚
â”‚ - æ”¯æŒå¤šæŒ‡æ ‡å¯¹æ¯”                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. æŒ‡æ ‡ç±»å‹é…ç½®è¡¨

#### metric_types - æŒ‡æ ‡ç±»å‹å®šä¹‰

```sql
CREATE TABLE metric_types (
    id SERIAL PRIMARY KEY,
    code VARCHAR(50) UNIQUE NOT NULL,        -- æŒ‡æ ‡ä»£ç ï¼šTTV, EEE, EFV
    name VARCHAR(100) NOT NULL,              -- æ˜¾ç¤ºåç§°
    description TEXT,                        -- æè¿°

    -- æ–‡ä»¶è¯†åˆ«
    file_pattern VARCHAR(100),               -- æ–‡ä»¶åæ¨¡å¼ï¼š*TTV*.txt
    file_extension VARCHAR(20) DEFAULT 'txt',

    -- å­—æ®µé…ç½®
    field_mapping JSONB,                     -- å­—æ®µæ˜ å°„é…ç½®

    -- æ±‡æ€»é…ç½®
    aggregation_config JSONB,                -- æ±‡æ€»è§„åˆ™é…ç½®

    -- çŠ¶æ€
    is_active BOOLEAN DEFAULT true,
    sort_order INTEGER DEFAULT 0,            -- æ˜¾ç¤ºæ’åº

    -- å…ƒæ•°æ®
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER REFERENCES users(id)
);

-- ç¤ºä¾‹æ•°æ®
INSERT INTO metric_types (code, name, description, file_pattern, field_mapping, aggregation_config)
VALUES
(
    'TTV',
    'äº¤æ˜“æ€»å€¼',
    'TTVäº¤æ˜“æŒ‡æ ‡æ•°æ®',
    '*TTV*.txt',
    '{
        "stock_code": {"column": 0, "type": "string", "required": true},
        "trade_date": {"column": 1, "type": "date", "required": true},
        "value": {"column": 2, "type": "bigint", "required": true}
    }',
    '{
        "concept_rank": {
            "enabled": true,
            "algorithm": "desc",
            "fields": ["value"]
        },
        "concept_summary": {
            "enabled": true,
            "aggregations": ["sum", "avg", "max", "min", "count"]
        }
    }'
),
(
    'EEE',
    'äº¤æ˜“æ´»è·ƒåº¦',
    'EEEæ´»è·ƒåº¦æŒ‡æ ‡æ•°æ®',
    '*EEE*.txt',
    '{
        "stock_code": {"column": 0, "type": "string", "required": true},
        "trade_date": {"column": 1, "type": "date", "required": true},
        "value": {"column": 2, "type": "bigint", "required": true}
    }',
    '{
        "concept_rank": {
            "enabled": true,
            "algorithm": "desc",
            "fields": ["value"]
        },
        "concept_summary": {
            "enabled": true,
            "aggregations": ["sum", "avg", "max"]
        }
    }'
);
```

**å­—æ®µè¯´æ˜**:
- `code`: æŒ‡æ ‡å”¯ä¸€æ ‡è¯†ï¼ˆTTV, EEEç­‰ï¼‰
- `file_pattern`: ç”¨äºè‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ç±»å‹
- `field_mapping`: å­—æ®µæ˜ å°„è§„åˆ™ï¼ˆJSONæ ¼å¼ï¼‰
- `aggregation_config`: æ±‡æ€»è®¡ç®—è§„åˆ™ï¼ˆJSONæ ¼å¼ï¼‰

---

### 2. æºæ•°æ®è¡¨ï¼ˆå¤šæŒ‡æ ‡æ”¯æŒï¼‰

#### stock_metric_data_raw - ç»Ÿä¸€çš„æºæ•°æ®è¡¨

```sql
CREATE TABLE stock_metric_data_raw (
    id BIGSERIAL,
    import_batch_id INTEGER NOT NULL REFERENCES import_records(id),

    -- æŒ‡æ ‡æ ‡è¯†
    metric_type_id INTEGER NOT NULL REFERENCES metric_types(id),
    metric_code VARCHAR(50) NOT NULL,        -- å†—ä½™å­—æ®µï¼Œä¾¿äºæŸ¥è¯¢

    -- è‚¡ç¥¨å’Œæ—¥æœŸ
    stock_code VARCHAR(20) NOT NULL,
    trade_date DATE NOT NULL,

    -- é€šç”¨æ•°å€¼å­—æ®µ
    value BIGINT,                            -- ä¸»è¦æ•°å€¼
    value_decimal DECIMAL(15, 2),           -- å°æ•°å€¼ï¼ˆå¯é€‰ï¼‰
    value_text VARCHAR(100),                 -- æ–‡æœ¬å€¼ï¼ˆå¯é€‰ï¼‰

    -- æ‰©å±•å­—æ®µï¼ˆJSONå­˜å‚¨ï¼‰
    extra_fields JSONB,                      -- é¢å¤–çš„å­—æ®µæ•°æ®

    -- å…ƒæ•°æ®
    source_file VARCHAR(255),
    source_row_number INTEGER,
    raw_data JSONB,                          -- å®Œæ•´åŸå§‹æ•°æ®

    -- çŠ¶æ€
    is_valid BOOLEAN DEFAULT true,
    validation_errors JSONB,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (id, trade_date)
) PARTITION BY RANGE (trade_date);

-- åˆ†åŒºç¤ºä¾‹
CREATE TABLE stock_metric_data_raw_2025_08 PARTITION OF stock_metric_data_raw
    FOR VALUES FROM ('2025-08-01') TO ('2025-09-01');

-- ç´¢å¼•
CREATE INDEX idx_metric_raw_type_code_date
    ON stock_metric_data_raw(metric_type_id, stock_code, trade_date);

CREATE INDEX idx_metric_raw_code
    ON stock_metric_data_raw(metric_code);

CREATE INDEX idx_metric_raw_batch
    ON stock_metric_data_raw(import_batch_id);

CREATE INDEX idx_metric_raw_date_type
    ON stock_metric_data_raw(trade_date, metric_type_id);
```

**è®¾è®¡è¯´æ˜**:
- ä½¿ç”¨ `metric_type_id` åŒºåˆ†ä¸åŒæŒ‡æ ‡
- `value` å­˜å‚¨ä¸»è¦æ•°å€¼ï¼Œæ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯
- `extra_fields` å­˜å‚¨æŒ‡æ ‡ç‰¹æœ‰çš„é¢å¤–å­—æ®µ
- `raw_data` å­˜å‚¨å®Œæ•´åŸå§‹æ•°æ®ï¼Œæ”¯æŒæœªæ¥æ‰©å±•

---

### 3. è®¡ç®—ç»“æœè¡¨ï¼ˆå¤šæŒ‡æ ‡æ”¯æŒï¼‰

#### stock_metric_data - æ ‡å‡†åŒ–åçš„æ•°æ®

```sql
CREATE TABLE stock_metric_data (
    id BIGSERIAL,
    metric_type_id INTEGER NOT NULL REFERENCES metric_types(id),
    metric_code VARCHAR(50) NOT NULL,

    stock_code VARCHAR(20) NOT NULL REFERENCES stocks(stock_code),
    trade_date DATE NOT NULL,

    -- æ•°å€¼
    value BIGINT,
    value_decimal DECIMAL(15, 2),

    -- è®¡ç®—å…ƒæ•°æ®
    computed_from_batch_id INTEGER REFERENCES import_records(id),
    computed_at TIMESTAMP,
    computation_version VARCHAR(20) DEFAULT 'v1.0',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (id, trade_date)
) PARTITION BY RANGE (trade_date);

-- å”¯ä¸€çº¦æŸ
CREATE UNIQUE INDEX idx_metric_data_unique
    ON stock_metric_data(metric_type_id, stock_code, trade_date);

CREATE INDEX idx_metric_data_type_date
    ON stock_metric_data(metric_type_id, trade_date);
```

#### concept_metric_rank - å¤šæŒ‡æ ‡æ’å

```sql
CREATE TABLE concept_metric_rank (
    id BIGSERIAL,
    concept_id INTEGER NOT NULL REFERENCES concepts(id),
    stock_code VARCHAR(20) NOT NULL REFERENCES stocks(stock_code),
    trade_date DATE NOT NULL,

    -- æŒ‡æ ‡æ ‡è¯†
    metric_type_id INTEGER NOT NULL REFERENCES metric_types(id),
    metric_code VARCHAR(50) NOT NULL,

    -- æ’åæ•°æ®
    value BIGINT,
    rank INTEGER,
    percentile DECIMAL(5, 2),

    -- è®¡ç®—å…ƒæ•°æ®
    computed_at TIMESTAMP,
    computation_version VARCHAR(20) DEFAULT 'v1.0',
    rank_algorithm VARCHAR(50) DEFAULT 'standard',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (id, trade_date)
) PARTITION BY RANGE (trade_date);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_concept_metric_rank_composite
    ON concept_metric_rank(concept_id, metric_type_id, trade_date, rank);

CREATE INDEX idx_concept_metric_rank_stock
    ON concept_metric_rank(stock_code, concept_id, metric_type_id, trade_date);
```

#### concept_metric_summary - å¤šæŒ‡æ ‡æ±‡æ€»

```sql
CREATE TABLE concept_metric_summary (
    id SERIAL PRIMARY KEY,
    concept_id INTEGER NOT NULL REFERENCES concepts(id),
    trade_date DATE NOT NULL,

    -- æŒ‡æ ‡æ ‡è¯†
    metric_type_id INTEGER NOT NULL REFERENCES metric_types(id),
    metric_code VARCHAR(50) NOT NULL,

    -- æ±‡æ€»æ•°æ®
    total_value BIGINT,
    avg_value BIGINT,
    max_value BIGINT,
    min_value BIGINT,
    stock_count INTEGER,

    -- æ‰©å±•æ±‡æ€»å­—æ®µï¼ˆJSONï¼‰
    custom_aggregations JSONB,               -- è‡ªå®šä¹‰æ±‡æ€»ç»“æœ

    -- è®¡ç®—å…ƒæ•°æ®
    computed_at TIMESTAMP,
    computation_version VARCHAR(20) DEFAULT 'v1.0',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(concept_id, metric_type_id, trade_date)
);

CREATE INDEX idx_concept_metric_summary_concept
    ON concept_metric_summary(concept_id, metric_type_id, trade_date);

CREATE INDEX idx_concept_metric_summary_date
    ON concept_metric_summary(trade_date, metric_type_id);
```

---

### 4. å¯¼å…¥è®°å½•å¢å¼º

#### import_records - å¢åŠ æŒ‡æ ‡ç±»å‹å­—æ®µ

```sql
ALTER TABLE import_records
ADD COLUMN metric_type_id INTEGER REFERENCES metric_types(id),
ADD COLUMN metric_code VARCHAR(50),
ADD COLUMN auto_detected_type BOOLEAN DEFAULT false;  -- æ˜¯å¦è‡ªåŠ¨æ£€æµ‹çš„ç±»å‹

-- ç´¢å¼•
CREATE INDEX idx_import_metric_type ON import_records(metric_type_id);
```

---

## ğŸ”„ æ•°æ®å¯¼å…¥æµç¨‹

### 1. æ–‡ä»¶ç±»å‹è‡ªåŠ¨è¯†åˆ«

```python
class MetricTypeDetector:
    """æŒ‡æ ‡ç±»å‹è‡ªåŠ¨æ£€æµ‹å™¨"""

    async def detect_metric_type(self, file_name: str) -> Optional[MetricType]:
        """
        æ ¹æ®æ–‡ä»¶åè‡ªåŠ¨è¯†åˆ«æŒ‡æ ‡ç±»å‹

        Args:
            file_name: æ–‡ä»¶åï¼Œå¦‚ "2025-08-21-TTV.txt"

        Returns:
            MetricType: è¯†åˆ«åˆ°çš„æŒ‡æ ‡ç±»å‹
        """
        # è·å–æ‰€æœ‰æ¿€æ´»çš„æŒ‡æ ‡ç±»å‹
        metric_types = await MetricType.filter(is_active=True).all()

        # æŒ‰æ–‡ä»¶æ¨¡å¼åŒ¹é…
        for metric_type in metric_types:
            pattern = metric_type.file_pattern
            if self._match_pattern(file_name, pattern):
                return metric_type

        # æœªè¯†åˆ«åˆ°ï¼Œè¿”å›None
        return None

    def _match_pattern(self, file_name: str, pattern: str) -> bool:
        """
        åŒ¹é…æ–‡ä»¶åæ¨¡å¼

        patternç¤ºä¾‹:
        - "*TTV*.txt" åŒ¹é… "2025-08-21-TTV.txt"
        - "*EEE*.txt" åŒ¹é… "data-EEE-20250821.txt"
        """
        import fnmatch
        return fnmatch.fnmatch(file_name.upper(), pattern.upper())
```

### 2. å¢å¼ºçš„å¯¼å…¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ–‡ä»¶ä¸Šä¼                                                   â”‚
â”‚    - ä¸Šä¼ æ–‡ä»¶                                                â”‚
â”‚    - è‡ªåŠ¨è¯†åˆ«æŒ‡æ ‡ç±»å‹ï¼ˆæ ¹æ®æ–‡ä»¶åï¼‰                           â”‚
â”‚    - å¦‚æœæ— æ³•è¯†åˆ«ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æŒ‡æ ‡ç±»å‹ç¡®è®¤                                              â”‚
â”‚    - æ˜¾ç¤ºè‡ªåŠ¨è¯†åˆ«çš„ç±»å‹                                       â”‚
â”‚    - å…è®¸ç”¨æˆ·ä¿®æ”¹                                            â”‚
â”‚    - åŠ è½½è¯¥æŒ‡æ ‡çš„å­—æ®µæ˜ å°„é…ç½®                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ•°æ®é¢„è§ˆ                                                  â”‚
â”‚    - æ ¹æ®å­—æ®µæ˜ å°„é…ç½®è§£ææ•°æ®                                 â”‚
â”‚    - æ˜¾ç¤ºæ˜ å°„ç»“æœé¢„è§ˆ                                         â”‚
â”‚    - æ•°æ®æ ¡éªŒ                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ•°æ®å¯¼å…¥ï¼ˆå†™å…¥æºæ•°æ®è¡¨ï¼‰                                   â”‚
â”‚    - åˆ›å»ºå¯¼å…¥æ‰¹æ¬¡è®°å½•ï¼ˆè®°å½•æŒ‡æ ‡ç±»å‹ï¼‰                         â”‚
â”‚    - å†™å…¥ stock_metric_data_raw                              â”‚
â”‚    - æ ‡è®° metric_type_id å’Œ metric_code                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ•°æ®è®¡ç®—                                                  â”‚
â”‚    - æ ¹æ®æŒ‡æ ‡ç±»å‹çš„æ±‡æ€»é…ç½®                                   â”‚
â”‚    - æ ‡å‡†åŒ–æ•°æ® â†’ stock_metric_data                          â”‚
â”‚    - è®¡ç®—æ’å â†’ concept_metric_rank                          â”‚
â”‚    - è®¡ç®—æ±‡æ€» â†’ concept_metric_summary                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å¯¼å…¥æœåŠ¡å®ç°

```python
class MetricImportService:
    """å¤šæŒ‡æ ‡å¯¼å…¥æœåŠ¡"""

    async def import_metric_file(
        self,
        file_path: str,
        metric_type: MetricType,
        user_id: int
    ) -> ImportRecord:
        """
        å¯¼å…¥æŒ‡æ ‡æ–‡ä»¶

        Args:
            file_path: æ–‡ä»¶è·¯å¾„
            metric_type: æŒ‡æ ‡ç±»å‹
            user_id: æ“ä½œç”¨æˆ·
        """
        # 1. åˆ›å»ºå¯¼å…¥è®°å½•
        import_record = await ImportRecord.create(
            user_id=user_id,
            file_path=file_path,
            metric_type_id=metric_type.id,
            metric_code=metric_type.code,
            status='processing'
        )

        # 2. è¯»å–æ–‡ä»¶å¹¶è§£æ
        rows = await self._parse_file(file_path, metric_type)

        # 3. æ‰¹é‡å†™å…¥æºæ•°æ®è¡¨
        await self._bulk_insert_raw_data(
            rows=rows,
            metric_type=metric_type,
            import_batch_id=import_record.id
        )

        # 4. è§¦å‘è®¡ç®—ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
        if should_compute_immediately:
            await self._trigger_computation(
                import_batch_id=import_record.id,
                metric_type=metric_type
            )

        return import_record

    async def _parse_file(
        self,
        file_path: str,
        metric_type: MetricType
    ) -> List[Dict]:
        """
        æ ¹æ®æŒ‡æ ‡ç±»å‹çš„å­—æ®µæ˜ å°„é…ç½®è§£ææ–‡ä»¶
        """
        field_mapping = metric_type.field_mapping
        rows = []

        with open(file_path, 'r') as f:
            for line_no, line in enumerate(f, 1):
                parts = line.strip().split('\t')

                # æ ¹æ®å­—æ®µæ˜ å°„æå–æ•°æ®
                row = {
                    'stock_code': self._extract_field(
                        parts, field_mapping['stock_code']
                    ),
                    'trade_date': self._extract_field(
                        parts, field_mapping['trade_date']
                    ),
                    'value': self._extract_field(
                        parts, field_mapping['value']
                    ),
                    'source_row_number': line_no,
                    'raw_data': parts  # ä¿ç•™åŸå§‹æ•°æ®
                }

                rows.append(row)

        return rows

    async def _bulk_insert_raw_data(
        self,
        rows: List[Dict],
        metric_type: MetricType,
        import_batch_id: int
    ):
        """æ‰¹é‡æ’å…¥æºæ•°æ®"""
        bulk_data = []
        for row in rows:
            bulk_data.append({
                'import_batch_id': import_batch_id,
                'metric_type_id': metric_type.id,
                'metric_code': metric_type.code,
                'stock_code': row['stock_code'],
                'trade_date': row['trade_date'],
                'value': row['value'],
                'source_row_number': row['source_row_number'],
                'raw_data': row['raw_data']
            })

        # æ‰¹é‡æ’å…¥
        await StockMetricDataRaw.bulk_create(bulk_data, batch_size=1000)
```

---

## ğŸ“Š å¤šæŒ‡æ ‡æ±‡æ€»é€»è¾‘

### 1. æ±‡æ€»è§„åˆ™é…ç½®

**JSONé…ç½®ç¤ºä¾‹**:

```json
{
  "TTV": {
    "concept_rank": {
      "enabled": true,
      "algorithm": "desc",
      "fields": ["value"],
      "null_handling": "exclude"
    },
    "concept_summary": {
      "enabled": true,
      "aggregations": ["sum", "avg", "max", "min", "count"],
      "custom_aggregations": [
        {
          "name": "top10_sum",
          "sql": "SUM(CASE WHEN rank <= 10 THEN value ELSE 0 END)"
        }
      ]
    }
  },
  "EEE": {
    "concept_rank": {
      "enabled": true,
      "algorithm": "desc",
      "fields": ["value"]
    },
    "concept_summary": {
      "enabled": true,
      "aggregations": ["sum", "avg", "max"],
      "custom_aggregations": [
        {
          "name": "active_count",
          "sql": "COUNT(CASE WHEN value > 100000 THEN 1 END)"
        }
      ]
    }
  },
  "EFV": {
    "concept_rank": {
      "enabled": true,
      "algorithm": "desc",
      "weight": 0.7
    },
    "concept_summary": {
      "enabled": true,
      "aggregations": ["sum", "weighted_avg"]
    }
  }
}
```

### 2. æ±‡æ€»è®¡ç®—æœåŠ¡

```python
class MetricAggregationService:
    """å¤šæŒ‡æ ‡æ±‡æ€»æœåŠ¡"""

    async def compute_concept_summary(
        self,
        concept_id: int,
        metric_type: MetricType,
        date: date
    ):
        """
        è®¡ç®—æŒ‡å®šæ¦‚å¿µã€æŒ‡å®šæŒ‡æ ‡çš„æ±‡æ€»æ•°æ®

        æ ¹æ®æŒ‡æ ‡ç±»å‹çš„æ±‡æ€»é…ç½®åŠ¨æ€è®¡ç®—
        """
        config = metric_type.aggregation_config
        summary_config = config.get('concept_summary', {})

        if not summary_config.get('enabled'):
            return

        # åŸºç¡€æ±‡æ€»
        aggregations = summary_config.get('aggregations', [])
        base_agg = self._build_base_aggregation_sql(aggregations)

        sql = f"""
        INSERT INTO concept_metric_summary
            (concept_id, metric_type_id, metric_code, trade_date,
             total_value, avg_value, max_value, min_value, stock_count)
        SELECT
            :concept_id,
            :metric_type_id,
            :metric_code,
            :date,
            {base_agg['sum']},
            {base_agg['avg']},
            {base_agg['max']},
            {base_agg['min']},
            {base_agg['count']}
        FROM stock_metric_data smd
        JOIN stock_concepts sc ON smd.stock_code = sc.stock_code
        WHERE sc.concept_id = :concept_id
          AND smd.metric_type_id = :metric_type_id
          AND smd.trade_date = :date
        ON CONFLICT (concept_id, metric_type_id, trade_date)
        DO UPDATE SET
            total_value = EXCLUDED.total_value,
            avg_value = EXCLUDED.avg_value,
            max_value = EXCLUDED.max_value,
            min_value = EXCLUDED.min_value,
            stock_count = EXCLUDED.stock_count,
            computed_at = NOW();
        """

        await db.execute(sql, {
            'concept_id': concept_id,
            'metric_type_id': metric_type.id,
            'metric_code': metric_type.code,
            'date': date
        })

        # è‡ªå®šä¹‰æ±‡æ€»
        custom_aggs = summary_config.get('custom_aggregations', [])
        if custom_aggs:
            await self._compute_custom_aggregations(
                concept_id, metric_type, date, custom_aggs
            )

    def _build_base_aggregation_sql(self, aggregations: List[str]) -> Dict[str, str]:
        """æ„å»ºåŸºç¡€æ±‡æ€»SQL"""
        agg_map = {
            'sum': 'COALESCE(SUM(smd.value), 0)',
            'avg': 'COALESCE(AVG(smd.value), 0)',
            'max': 'COALESCE(MAX(smd.value), 0)',
            'min': 'COALESCE(MIN(smd.value), 0)',
            'count': 'COUNT(*)'
        }

        return {agg: agg_map.get(agg, '0') for agg in aggregations}
```

---

## ğŸ”Œ APIè®¾è®¡

### 1. æŒ‡æ ‡ç±»å‹ç®¡ç†API

```http
# è·å–æ‰€æœ‰æŒ‡æ ‡ç±»å‹
GET /api/v1/metric-types

# åˆ›å»ºæ–°æŒ‡æ ‡ç±»å‹
POST /api/v1/metric-types
{
  "code": "AAA",
  "name": "æ–°æŒ‡æ ‡AAA",
  "file_pattern": "*AAA*.txt",
  "field_mapping": {...},
  "aggregation_config": {...}
}

# æ›´æ–°æŒ‡æ ‡ç±»å‹
PUT /api/v1/metric-types/{id}

# åˆ é™¤æŒ‡æ ‡ç±»å‹ï¼ˆè½¯åˆ é™¤ï¼‰
DELETE /api/v1/metric-types/{id}
```

### 2. å¤šæŒ‡æ ‡æŸ¥è¯¢API

```http
# æŸ¥è¯¢è‚¡ç¥¨åœ¨å¤šä¸ªæŒ‡æ ‡ä¸­çš„æ’å
GET /api/v1/stocks/{code}/metric-ranks?date=2025-08-21&metrics=TTV,EEE

# å“åº”
{
  "stock_code": "600000",
  "date": "2025-08-21",
  "metrics": {
    "TTV": {
      "value": 1000000,
      "concept_ranks": [
        {"concept": "äººå·¥æ™ºèƒ½", "rank": 5, "percentile": 90.5}
      ]
    },
    "EEE": {
      "value": 800000,
      "concept_ranks": [
        {"concept": "äººå·¥æ™ºèƒ½", "rank": 8, "percentile": 85.2}
      ]
    }
  }
}

# æŸ¥è¯¢æ¦‚å¿µåœ¨å¤šä¸ªæŒ‡æ ‡çš„æ±‡æ€»
GET /api/v1/concepts/{id}/metric-summary?date=2025-08-21&metrics=TTV,EEE

# å“åº”
{
  "concept_id": 1,
  "concept_name": "äººå·¥æ™ºèƒ½",
  "date": "2025-08-21",
  "metrics": {
    "TTV": {
      "total_value": 100000000,
      "avg_value": 666666,
      "max_value": 10000000,
      "stock_count": 150
    },
    "EEE": {
      "total_value": 80000000,
      "avg_value": 533333,
      "max_value": 8000000,
      "stock_count": 150
    }
  }
}

# å¤šæŒ‡æ ‡å¯¹æ¯”
POST /api/v1/analysis/metric-comparison
{
  "concept_id": 1,
  "metrics": ["TTV", "EEE", "EFV"],
  "date_range": {
    "start": "2025-08-01",
    "end": "2025-08-31"
  }
}
```

### 3. å¯¼å…¥APIå¢å¼º

```http
# ä¸Šä¼ æ–‡ä»¶ï¼ˆè‡ªåŠ¨è¯†åˆ«æŒ‡æ ‡ç±»å‹ï¼‰
POST /api/v1/import/upload
FormData: {file}

# å“åº”
{
  "file_path": "/uploads/2025-08-21-TTV.txt",
  "detected_metric": {
    "id": 1,
    "code": "TTV",
    "name": "äº¤æ˜“æ€»å€¼"
  },
  "auto_detected": true
}

# æ‰§è¡Œå¯¼å…¥ï¼ˆæŒ‡å®šæŒ‡æ ‡ç±»å‹ï¼‰
POST /api/v1/import/execute
{
  "file_path": "/uploads/2025-08-21-TTV.txt",
  "metric_type_id": 1,
  "import_mode": "increment"
}
```

---

## ğŸ¨ ç”¨æˆ·ç•Œé¢è®¾è®¡

### 1. æŒ‡æ ‡ç±»å‹ç®¡ç†é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡ç±»å‹ç®¡ç†                            [æ–°å»ºæŒ‡æ ‡ç±»å‹] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ä»£ç  | åç§°    | æ–‡ä»¶æ¨¡å¼   | çŠ¶æ€ | æ“ä½œ    â”‚   â”‚
â”‚ â”‚ TTV  â”‚äº¤æ˜“æ€»å€¼ â”‚*TTV*.txt  â”‚å¯ç”¨  â”‚[ç¼–è¾‘]   â”‚   â”‚
â”‚ â”‚ EEE  â”‚æ´»è·ƒåº¦   â”‚*EEE*.txt  â”‚å¯ç”¨  â”‚[ç¼–è¾‘]   â”‚   â”‚
â”‚ â”‚ EFV  â”‚æµåŠ¨æ€§   â”‚*EFV*.txt  â”‚å¯ç”¨  â”‚[ç¼–è¾‘]   â”‚   â”‚
â”‚ â”‚ AAA  â”‚æŒ‡æ ‡AAA  â”‚*AAA*.txt  â”‚ç¦ç”¨  â”‚[ç¼–è¾‘]   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ–°å»º/ç¼–è¾‘æŒ‡æ ‡ç±»å‹å¯¹è¯æ¡†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–°å»ºæŒ‡æ ‡ç±»å‹                               [x]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚ åŸºæœ¬ä¿¡æ¯:                                           â”‚
â”‚   ä»£ç *: [TTV________]                              â”‚
â”‚   åç§°*: [äº¤æ˜“æ€»å€¼____]                             â”‚
â”‚   æè¿°:  [_______________________________]         â”‚
â”‚                                                      â”‚
â”‚ æ–‡ä»¶è¯†åˆ«:                                           â”‚
â”‚   æ–‡ä»¶æ¨¡å¼*: [*TTV*.txt]                           â”‚
â”‚   æ–‡ä»¶æ‰©å±•å: [txt â–¼]                              â”‚
â”‚                                                      â”‚
â”‚ å­—æ®µæ˜ å°„:                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚ å­—æ®µå    â”‚ åˆ—ä½ç½® â”‚ æ•°æ®ç±»å‹ â”‚å¿…å¡«â”‚          â”‚
â”‚   â”‚ stock_codeâ”‚   0    â”‚ string  â”‚ â˜‘ â”‚          â”‚
â”‚   â”‚ trade_dateâ”‚   1    â”‚ date    â”‚ â˜‘ â”‚          â”‚
â”‚   â”‚ value     â”‚   2    â”‚ bigint  â”‚ â˜‘ â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚   [æ·»åŠ å­—æ®µ]                                        â”‚
â”‚                                                      â”‚
â”‚ æ±‡æ€»é…ç½®:                                           â”‚
â”‚   â˜‘ å¯ç”¨æ¦‚å¿µæ’åè®¡ç®—                                â”‚
â”‚       æ’åç®—æ³•: [é™åº â–¼]                           â”‚
â”‚                                                      â”‚
â”‚   â˜‘ å¯ç”¨æ¦‚å¿µæ±‡æ€»è®¡ç®—                                â”‚
â”‚       æ±‡æ€»å‡½æ•°: â˜‘ SUM  â˜‘ AVG  â˜‘ MAX                â”‚
â”‚                 â˜‘ MIN  â˜‘ COUNT                     â”‚
â”‚                                                      â”‚
â”‚ [å–æ¶ˆ]                              [ä¿å­˜]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å¯¼å…¥é¡µé¢å¢å¼º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®å¯¼å…¥                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ–‡ä»¶: 2025-08-21-TTV.txt                            â”‚
â”‚                                                      â”‚
â”‚ æŒ‡æ ‡ç±»å‹:                                           â”‚
â”‚   â— è‡ªåŠ¨è¯†åˆ«: TTV - äº¤æ˜“æ€»å€¼                        â”‚
â”‚   â—‹ æ‰‹åŠ¨é€‰æ‹©: [è¯·é€‰æ‹© â–¼]                           â”‚
â”‚                                                      â”‚
â”‚ æ•°æ®é¢„è§ˆ: (æ ¹æ®TTVçš„å­—æ®µæ˜ å°„)                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ è‚¡ç¥¨ä»£ç  | äº¤æ˜“æ—¥æœŸ   | äº¤æ˜“æ€»å€¼    â”‚           â”‚
â”‚ â”‚ SH600000 | 2025-08-21 | 459400     â”‚           â”‚
â”‚ â”‚ SH600004 | 2025-08-21 | 375249     â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                      â”‚
â”‚ å¯¼å…¥é€‰é¡¹:                                           â”‚
â”‚   â˜‘ ä¿ç•™æºæ•°æ®                                      â”‚
â”‚   â— ç«‹å³è®¡ç®—    â—‹ ç¨åæ‰‹åŠ¨è§¦å‘                     â”‚
â”‚                                                      â”‚
â”‚ [å¼€å§‹å¯¼å…¥]                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. å¤šæŒ‡æ ‡å¯¹æ¯”é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤šæŒ‡æ ‡å¯¹æ¯”åˆ†æ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ¦‚å¿µ: [äººå·¥æ™ºèƒ½ â–¼]                                     â”‚
â”‚ æ—¥æœŸ: [2025-08-01] åˆ° [2025-08-31]                    â”‚
â”‚ æŒ‡æ ‡: â˜‘ TTV  â˜‘ EEE  â˜‘ EFV  â–¡ AAA                      â”‚
â”‚                                                          â”‚
â”‚ è¶‹åŠ¿å¯¹æ¯”å›¾:                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚                    â•±TTV                        â”‚     â”‚
â”‚ â”‚              â•±â•²  â•±                             â”‚     â”‚
â”‚ â”‚         â•±â•²â•±  â•²â•±                                â”‚     â”‚
â”‚ â”‚    EEEâ•±                    EFV                 â”‚     â”‚
â”‚ â”‚  â•±â•²â•±                    â•±â•²                     â”‚     â”‚
â”‚ â”‚â•±                    â•±â•²â•±  â•²                     â”‚     â”‚
â”‚ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ—¥æœŸ     â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                          â”‚
â”‚ æŒ‡æ ‡æ±‡æ€»å¯¹æ¯”:                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ æŒ‡æ ‡ â”‚ æ€»å’Œ      â”‚ å¹³å‡å€¼  â”‚ æœ€å¤§å€¼   â”‚ ç›¸å…³æ€§â”‚     â”‚
â”‚ â”‚ TTV  â”‚100,000,000â”‚ 666,666 â”‚10,000,000â”‚  1.0 â”‚     â”‚
â”‚ â”‚ EEE  â”‚ 80,000,000â”‚ 533,333 â”‚ 8,000,000â”‚  0.85â”‚     â”‚
â”‚ â”‚ EFV  â”‚ 60,000,000â”‚ 400,000 â”‚ 6,000,000â”‚  0.72â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ‰©å±•æ–°æŒ‡æ ‡æµç¨‹

### æ·»åŠ æ–°æŒ‡æ ‡ç±»å‹ï¼ˆå¦‚AAA.txtï¼‰çš„æ­¥éª¤

**1. é€šè¿‡ç•Œé¢åˆ›å»ºæŒ‡æ ‡ç±»å‹é…ç½®**:
```
ä»£ç : AAA
åç§°: æ–°æŒ‡æ ‡AAA
æ–‡ä»¶æ¨¡å¼: *AAA*.txt
å­—æ®µæ˜ å°„: {
  "stock_code": {"column": 0, "type": "string"},
  "trade_date": {"column": 1, "type": "date"},
  "value": {"column": 2, "type": "bigint"}
}
æ±‡æ€»é…ç½®: {
  "concept_rank": {"enabled": true, "algorithm": "desc"},
  "concept_summary": {"enabled": true, "aggregations": ["sum", "avg"]}
}
```

**2. ç³»ç»Ÿè‡ªåŠ¨æ”¯æŒ**:
- âœ… æ–‡ä»¶ä¸Šä¼ æ—¶è‡ªåŠ¨è¯†åˆ«AAAç±»å‹
- âœ… ä½¿ç”¨é…ç½®çš„å­—æ®µæ˜ å°„è§£ææ•°æ®
- âœ… å†™å…¥ç»Ÿä¸€çš„æºæ•°æ®è¡¨ï¼ˆæ ‡è®°metric_code='AAA'ï¼‰
- âœ… æ ¹æ®æ±‡æ€»é…ç½®è®¡ç®—æ’åå’Œæ±‡æ€»

**3. æ— éœ€ä¿®æ”¹ä»£ç **:
- âœ… æ— éœ€ä¿®æ”¹æ•°æ®åº“è¡¨ç»“æ„
- âœ… æ— éœ€ä¿®æ”¹å¯¼å…¥ä»£ç 
- âœ… æ— éœ€ä¿®æ”¹æŸ¥è¯¢API
- âœ… åªéœ€é…ç½®æ–°çš„æŒ‡æ ‡ç±»å‹

---

## ğŸ“Š æ•°æ®æŸ¥è¯¢ç¤ºä¾‹

### 1. æŸ¥è¯¢TTVæŒ‡æ ‡çš„æ•°æ®

```sql
-- æŸ¥è¯¢æŸè‚¡ç¥¨TTVæŒ‡æ ‡çš„å†å²æ•°æ®
SELECT
    trade_date,
    value as ttv_value
FROM stock_metric_data
WHERE stock_code = '600000'
  AND metric_code = 'TTV'
  AND trade_date BETWEEN '2025-08-01' AND '2025-08-31'
ORDER BY trade_date;
```

### 2. æŸ¥è¯¢å¤šæŒ‡æ ‡å¯¹æ¯”

```sql
-- æŸ¥è¯¢æŸè‚¡ç¥¨åœ¨äººå·¥æ™ºèƒ½æ¦‚å¿µä¸­çš„å¤šæŒ‡æ ‡æ’å
SELECT
    cmr.metric_code,
    mt.name as metric_name,
    cmr.value,
    cmr.rank,
    cmr.percentile
FROM concept_metric_rank cmr
JOIN metric_types mt ON cmr.metric_type_id = mt.id
WHERE cmr.stock_code = '600000'
  AND cmr.concept_id = 1
  AND cmr.trade_date = '2025-08-21'
ORDER BY cmr.metric_code;
```

### 3. æ¦‚å¿µå¤šæŒ‡æ ‡æ±‡æ€»

```sql
-- æŸ¥è¯¢äººå·¥æ™ºèƒ½æ¦‚å¿µçš„å¤šæŒ‡æ ‡æ±‡æ€»
SELECT
    cms.metric_code,
    mt.name as metric_name,
    cms.total_value,
    cms.avg_value,
    cms.max_value,
    cms.stock_count
FROM concept_metric_summary cms
JOIN metric_types mt ON cms.metric_type_id = mt.id
WHERE cms.concept_id = 1
  AND cms.trade_date = '2025-08-21'
ORDER BY cms.metric_code;
```

---

## ğŸ¯ å®ç°ä¼˜å…ˆçº§

### Phase 1: åŸºç¡€å¤šæŒ‡æ ‡æ”¯æŒï¼ˆå¿…é¡»ï¼‰

- [ ] åˆ›å»º `metric_types` è¡¨
- [ ] åˆ›å»º `stock_metric_data_raw` è¡¨
- [ ] åˆ›å»º `stock_metric_data` è¡¨
- [ ] åˆ›å»º `concept_metric_rank` è¡¨
- [ ] åˆ›å»º `concept_metric_summary` è¡¨
- [ ] æŒ‡æ ‡ç±»å‹è‡ªåŠ¨æ£€æµ‹
- [ ] åŸºç¡€å¯¼å…¥æµç¨‹æ”¯æŒå¤šæŒ‡æ ‡

### Phase 2: é…ç½®åŒ–ï¼ˆé‡è¦ï¼‰

- [ ] æŒ‡æ ‡ç±»å‹ç®¡ç†ç•Œé¢
- [ ] å­—æ®µæ˜ å°„é…ç½®
- [ ] æ±‡æ€»è§„åˆ™é…ç½®
- [ ] æŒ‡æ ‡ç±»å‹CRUD API

### Phase 3: é«˜çº§åŠŸèƒ½ï¼ˆå¢å¼ºï¼‰

- [ ] å¤šæŒ‡æ ‡å¯¹æ¯”åˆ†æ
- [ ] è‡ªå®šä¹‰æ±‡æ€»å‡½æ•°
- [ ] æŒ‡æ ‡ç›¸å…³æ€§åˆ†æ
- [ ] æŒ‡æ ‡æƒé‡é…ç½®

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æŒ‡æ ‡ä»£ç å‘½åè§„èŒƒ

```
- ä½¿ç”¨å¤§å†™å­—æ¯
- 3-5ä¸ªå­—ç¬¦
- è¯­ä¹‰æ˜ç¡®
- é¿å…é‡å¤

æ¨è: TTV, EEE, EFV, AAA
ä¸æ¨è: t1, metric1, data
```

### 2. å­—æ®µæ˜ å°„é…ç½®

```json
{
  "stock_code": {
    "column": 0,              // åˆ—ä½ç½®ï¼ˆä»0å¼€å§‹ï¼‰
    "type": "string",         // æ•°æ®ç±»å‹
    "required": true,         // æ˜¯å¦å¿…å¡«
    "pattern": "^[0-9]{6}$"  // å¯é€‰ï¼šæ­£åˆ™éªŒè¯
  },
  "trade_date": {
    "column": 1,
    "type": "date",
    "required": true,
    "format": "YYYY-MM-DD"    // æ—¥æœŸæ ¼å¼
  },
  "value": {
    "column": 2,
    "type": "bigint",
    "required": true,
    "min": 0,                 // å¯é€‰ï¼šæœ€å°å€¼
    "max": 999999999999       // å¯é€‰ï¼šæœ€å¤§å€¼
  }
}
```

### 3. æ±‡æ€»é…ç½®æœ€ä½³å®è·µ

```json
{
  "concept_rank": {
    "enabled": true,
    "algorithm": "desc",      // desc: é™åº, asc: å‡åº
    "null_handling": "exclude" // exclude: æ’é™¤ç©ºå€¼, zero: å½“ä½œ0
  },
  "concept_summary": {
    "enabled": true,
    "aggregations": ["sum", "avg", "max", "min", "count"],
    "custom_aggregations": [
      {
        "name": "top10_sum",
        "description": "å‰10åæ€»å’Œ",
        "sql": "SUM(CASE WHEN rank <= 10 THEN value ELSE 0 END)"
      }
    ]
  }
}
```

---

## âœ… æ€»ç»“

è¿™ä¸ªè®¾è®¡æä¾›äº†ï¼š

1. âœ… **å®Œå…¨çµæ´»çš„å¤šæŒ‡æ ‡æ”¯æŒ** - æ”¯æŒTTVã€EEEã€EFVã€AAAç­‰ä»»æ„å¤šç§æŒ‡æ ‡
2. âœ… **åŠ¨æ€æ‰©å±•** - æ–°å¢æŒ‡æ ‡ç±»å‹æ— éœ€ä¿®æ”¹ä»£ç å’Œæ•°æ®åº“ç»“æ„
3. âœ… **é…ç½®åŒ–** - é€šè¿‡ç•Œé¢é…ç½®æŒ‡æ ‡ç±»å‹ã€å­—æ®µæ˜ å°„ã€æ±‡æ€»è§„åˆ™
4. âœ… **ç‹¬ç«‹æ±‡æ€»é€»è¾‘** - æ¯ç§æŒ‡æ ‡æœ‰è‡ªå·±ç‹¬ç«‹çš„è®¡ç®—è§„åˆ™
5. âœ… **ç»Ÿä¸€ç®¡ç†** - æ‰€æœ‰æŒ‡æ ‡ä½¿ç”¨ç»Ÿä¸€çš„å¯¼å…¥ã€æŸ¥è¯¢ã€é‡ç®—æ¥å£
6. âœ… **å¤šæŒ‡æ ‡å¯¹æ¯”** - æ”¯æŒå¤šä¸ªæŒ‡æ ‡çš„å¯¹æ¯”åˆ†æ

**æ ¸å¿ƒä¼˜åŠ¿**:
- æ–°å¢æŒ‡æ ‡ç±»å‹åªéœ€é…ç½®ï¼Œæ— éœ€å¼€å‘
- æ‰€æœ‰æŒ‡æ ‡æ•°æ®ç»Ÿä¸€å­˜å‚¨ï¼Œä¾¿äºç®¡ç†
- æ”¯æŒä»»æ„å¤æ‚çš„æ±‡æ€»é€»è¾‘
- å®Œå…¨å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

---

## ğŸ“Š é™„å½•ï¼šæ±‡æ€»æ•°æ®å­˜å‚¨ç­–ç•¥å†³ç­–

> **é‡è¦**: å®Œæ•´åˆ†æè¯·å‚è€ƒ [METRIC_STORAGE_STRATEGY.md](./METRIC_STORAGE_STRATEGY.md)

### é—®é¢˜ï¼šå¤šæŒ‡æ ‡æ±‡æ€»ç»“æœæ˜¯ç»Ÿä¸€å­˜å‚¨è¿˜æ˜¯åˆ†è¡¨å­˜å‚¨ï¼Ÿ

**æ¨èæ–¹æ¡ˆï¼šç»Ÿä¸€è¡¨ + JSONBæ‰©å±•å­—æ®µ** â­â­â­â­â­

### æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- æ‰€æœ‰æŒ‡æ ‡çš„æ±‡æ€»éƒ½å­˜åœ¨è¿™ä¸€ä¸ªè¡¨
CREATE TABLE concept_metric_summary (
    concept_id INTEGER,
    metric_type_id INTEGER,      -- åŒºåˆ†ä¸åŒæŒ‡æ ‡
    metric_code VARCHAR(50),      -- TTV, EEE, EFV

    -- é€šç”¨å­—æ®µï¼ˆæ‰€æœ‰æŒ‡æ ‡éƒ½æœ‰ï¼‰
    total_value BIGINT,
    avg_value BIGINT,
    max_value BIGINT,
    min_value BIGINT,
    stock_count INTEGER,

    -- æ‰©å±•å­—æ®µï¼ˆæŒ‡æ ‡ç‰¹æœ‰çš„æ±‡æ€»ï¼‰
    custom_aggregations JSONB,    -- {"top10_sum": 50M, "active_count": 80}

    UNIQUE(concept_id, metric_type_id, trade_date)
);
```

### æ•°æ®ç¤ºä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ concept_id â”‚metric_code â”‚ total_value â”‚ avg_value â”‚ custom_aggregations  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     1      â”‚    TTV     â”‚ 100,000,000 â”‚  666,666  â”‚ {"top10_sum": 50M}   â”‚
â”‚     1      â”‚    EEE     â”‚  80,000,000 â”‚  533,333  â”‚ {"active_cnt": 80}   â”‚
â”‚     1      â”‚    EFV     â”‚  60,000,000 â”‚  400,000  â”‚ {"flow_rate": 0.75}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆé€‰æ‹©ç»Ÿä¸€è¡¨ï¼Ÿ

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **å¤šæŒ‡æ ‡å¯¹æ¯”è¶…ç®€å•** | ä¸€ä¸ªSQLæŸ¥è¯¢æ‰€æœ‰æŒ‡æ ‡ |
| **æ–°å¢æŒ‡æ ‡é›¶æˆæœ¬** | ä¸éœ€è¦åˆ›å»ºæ–°è¡¨ |
| **ä»£ç ç»Ÿä¸€** | ä¸€å¥—ä»£ç å¤„ç†æ‰€æœ‰æŒ‡æ ‡ |
| **JSONBçµæ´»æ€§** | æ¯ç§æŒ‡æ ‡å¯ä»¥æœ‰è‡ªå·±çš„ç‰¹æ®Šå­—æ®µ |
| **æ€§èƒ½ä¼˜ç§€** | PostgreSQLçš„JSONBæ”¯æŒç´¢å¼• |

### æŸ¥è¯¢ç¤ºä¾‹

```sql
-- å¤šæŒ‡æ ‡å¯¹æ¯”ï¼ˆä¸€ä¸ªæŸ¥è¯¢æå®šï¼‰
SELECT metric_code, total_value, avg_value
FROM concept_metric_summary
WHERE concept_id = 1 AND trade_date = '2025-08-21';

-- æŸ¥è¯¢TTVç‰¹æœ‰å­—æ®µ
SELECT
    total_value,
    custom_aggregations->>'top10_sum' as top10_sum
FROM concept_metric_summary
WHERE metric_code = 'TTV' AND concept_id = 1;
```

### å¯¹æ¯”æ–¹æ¡ˆï¼šåˆ†è¡¨å­˜å‚¨

**ä¸æ¨è**ï¼Œå› ä¸ºï¼š
- âŒ æ¯ç§æŒ‡æ ‡éœ€è¦å•ç‹¬çš„è¡¨ï¼ˆconcept_ttv_summary, concept_eee_summary...ï¼‰
- âŒ å¤šæŒ‡æ ‡å¯¹æ¯”éœ€è¦UNIONå¤šä¸ªè¡¨
- âŒ æ–°å¢æŒ‡æ ‡éœ€è¦åˆ›å»ºæ–°è¡¨
- âŒ ä»£ç é‡å¤ï¼Œç»´æŠ¤æˆæœ¬é«˜

**è¯¦ç»†åˆ†æ**: å‚è§ [METRIC_STORAGE_STRATEGY.md](./METRIC_STORAGE_STRATEGY.md)
