# 系统设计文档

**项目名称**: 股票概念分析系统
**版本**: v2.0
**更新日期**: 2025-11-23

---

## 1. 项目概述

### 1.1 项目背景

基于股票概念数据和交易数据，开发一个综合分析系统，用于：
- 管理股票与概念的关联关系
- 分析股票在不同概念中的表现和排名
- 提供多维度的数据查询和可视化

### 1.2 核心目标

- **数据管理**: 支持CSV和多种TXT文件导入
- **多维分析**: 支持6大核心分析需求
- **可视化**: 直观的图表和排名展示
- **权限控制**: 完整的用户和权限管理

---

## 2. 核心需求

### 2.1 数据文件类型

| 文件类型 | 内容 | 格式 |
|---------|------|------|
| **CSV** | 股票-概念-行业映射 | `股票代码,股票名称,概念,行业...` |
| **TXT** | 交易数据（多指标） | `SH600000\t2025-08-21\t459400` |

**TXT文件特点**:
- 指标类型：TTV、EEE、EFV、AAA等（可扩展）
- 股票代码带前缀：SH（上海）、SZ（深圳）、BJ（北京）
- 每个文件对应一个交易日期

### 2.2 六大核心分析需求

| 序号 | 需求描述 | 实现方式 |
|-----|---------|---------|
| 1 | 查询股票所属的概念 | 直接查询关系表 |
| 2 | 概念每日所有股票交易量汇总 | 预计算存储 |
| 3 | 概念中按排名排序的股票列表 | 预计算存储 |
| 4 | 股票在日期范围内出现前N名次数 | 实时聚合查询 |
| 5 | 股票在概念中的排名历史 | 预计算存储 |
| 6 | 股票在概念中每天的排名 | 预计算存储 |

---

## 3. 系统架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层                              │
├───────────────────────┬─────────────────────────────────────┤
│     后台管理端         │           用户展示端                 │
│  Vue 3 + Element Plus │      Vue 3 + Ant Design Vue         │
└───────────────────────┴─────────────────────────────────────┘
                              │ HTTPS
┌─────────────────────────────────────────────────────────────┐
│                     Nginx (反向代理)                         │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    FastAPI 应用服务                          │
│  ┌──────────┬──────────┬──────────┬──────────┐             │
│  │ 认证服务  │ 查询服务  │ 导入服务  │ 统计服务  │             │
│  └──────────┴──────────┴──────────┴──────────┘             │
│  ┌─────────────────────────────────────────────┐           │
│  │         Celery Worker (异步任务)              │           │
│  │     数据导入 / 排名计算 / 汇总计算             │           │
│  └─────────────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────────┘
                              │
┌──────────────┬──────────────┬──────────────┐
│  PostgreSQL  │    Redis     │    MinIO     │
│   (主数据库)  │   (缓存)     │  (文件存储)   │
└──────────────┴──────────────┴──────────────┘
```

### 3.2 技术栈

| 层级 | 技术 | 版本 |
|-----|------|------|
| **后端框架** | FastAPI | 0.115+ |
| **数据库** | PostgreSQL | 15+ |
| **缓存** | Redis | 7+ |
| **异步任务** | Celery | 5.3+ |
| **前端框架** | Vue 3 + TypeScript | 3.4+ |
| **UI组件** | Element Plus / Ant Design Vue | Latest |
| **图表** | Apache ECharts | 5.5+ |
| **容器化** | Docker + Docker Compose | Latest |

### 3.3 分层架构

```
┌─────────────────────────────────────────┐
│         Presentation Layer              │  Vue 3 前端
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│           API Layer                     │  FastAPI Routers
│   /auth  /stocks  /concepts  /import    │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│          Service Layer                  │  业务逻辑
│  AuthService / StockService / ...       │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│        Data Access Layer                │  Repository Pattern
│           SQLAlchemy ORM                │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│           Data Layer                    │  PostgreSQL + Redis
└─────────────────────────────────────────┘
```

---

## 4. 功能模块设计

### 4.1 用户认证模块

**功能清单**:
- 用户登录/登出（JWT认证）
- 用户管理（CRUD）
- 角色管理（RBAC）
- 操作日志记录

**角色定义**:

| 角色 | 权限 |
|-----|------|
| super_admin | 全部权限 |
| admin | 数据管理、用户管理 |
| analyst | 高级查询、导出 |
| viewer | 基础查询 |

### 4.2 数据导入模块

**功能清单**:
- CSV文件导入（股票-概念映射）
- TXT文件导入（多指标交易数据）
- 自动识别指标类型
- 股票代码前缀分离
- 导入进度实时推送（WebSocket）
- 导入后自动计算排名和汇总

**导入流程**:

```
文件上传 → 格式校验 → 创建批次 → 解析数据 → 存入Raw表
    ↓
校验通过 → 同步主数据 → 触发计算任务 → 更新预计算表
    ↓
完成 → 更新批次状态 → 通知前端
```

### 4.3 数据查询模块

**查询类型**:

| 查询 | 说明 | 性能 |
|-----|------|------|
| 股票概念查询 | 查询股票所属概念 | <10ms |
| 概念排名查询 | 概念中股票排名列表 | <50ms |
| 排名历史查询 | 股票排名趋势 | <100ms |
| 汇总统计查询 | 概念日汇总数据 | <50ms |
| 前N名统计 | 聚合查询 | <200ms |

### 4.4 数据可视化模块

**图表类型**:
- 排名趋势折线图
- 概念交易量柱状图
- 排名分布热力图
- 多指标对比图

---

## 5. 数据流设计

### 5.1 导入数据流

```
┌─────────┐    ┌─────────┐    ┌─────────────┐    ┌─────────────┐
│ CSV文件  │ → │ 解析器   │ → │ Raw表        │ → │ 主数据表     │
│ TXT文件  │    │         │    │ (源数据保留) │    │ (stocks等)  │
└─────────┘    └─────────┘    └─────────────┘    └─────────────┘
                                    │
                                    ↓
                            ┌─────────────┐
                            │ 计算引擎     │
                            │ (排名/汇总)  │
                            └─────────────┘
                                    │
                                    ↓
                            ┌─────────────┐
                            │ 预计算表     │
                            │ (rank/summary)│
                            └─────────────┘
```

### 5.2 查询数据流

```
┌─────────┐    ┌─────────┐    ┌─────────────┐    ┌─────────┐
│ 前端请求 │ → │ API层   │ → │ 预计算表     │ → │ 返回结果 │
└─────────┘    └─────────┘    │ (毫秒级响应) │    └─────────┘
                              └─────────────┘
```

---

## 6. 安全设计

### 6.1 认证机制

- JWT Token认证（Access Token + Refresh Token）
- Access Token有效期：2小时
- Refresh Token有效期：7天
- 密码加密：bcrypt

### 6.2 权限控制

- 基于RBAC的权限模型
- API级别权限校验
- 数据级别权限过滤（可选）

### 6.3 数据安全

- SQL注入防护（ORM参数化）
- XSS防护（输入过滤）
- CSRF防护（Token验证）
- 敏感数据加密存储

---

## 7. 性能设计

### 7.1 数据库优化

- 表分区（按月分区，自动剪枝）
- 复合索引（针对查询场景定制）
- 预计算（排名、汇总导入时计算）

### 7.2 缓存策略

| 数据类型 | 缓存时间 | 说明 |
|---------|---------|------|
| 概念列表 | 1小时 | 变化少 |
| 股票基础信息 | 30分钟 | 变化少 |
| 排名数据 | 5分钟 | 查询频繁 |
| 汇总数据 | 10分钟 | 查询频繁 |

### 7.3 性能指标

| 指标 | 目标值 |
|-----|-------|
| API响应时间(P95) | <500ms |
| 导入速度 | 10万行/分钟 |
| 并发支持 | 100用户 |

---

## 8. 部署架构

### 8.1 单机部署（MVP阶段）

```
┌─────────────────────────────────────────────┐
│                 单台服务器                   │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │  Nginx  │ │ FastAPI │ │ Celery  │       │
│  └─────────┘ └─────────┘ └─────────┘       │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │PostgreSQL│ │  Redis  │ │  MinIO  │       │
│  └─────────┘ └─────────┘ └─────────┘       │
└─────────────────────────────────────────────┘
```

### 8.2 Docker Compose配置

```yaml
services:
  nginx:        # 反向代理
  backend:      # FastAPI应用
  celery:       # 异步任务
  postgres:     # 数据库
  redis:        # 缓存
  minio:        # 文件存储
```

---

## 9. 关键设计决策

### 9.1 预计算 vs 实时计算

| 数据 | 决策 | 原因 |
|-----|------|------|
| 排名数据 | 预计算 | 窗口函数计算复杂 |
| 概念汇总 | 预计算 | 聚合数据量大 |
| 前N名次数 | 实时计算 | N值可变，基于排名表聚合快 |

### 9.2 源数据保留

- 所有导入数据存入Raw表，永久保留
- 计算结果可重新生成
- 支持算法升级后重算历史数据

### 9.3 多指标扩展

- 指标类型配置化（metric_types表）
- 新增指标只需配置，无需改代码
- 统一存储，统一查询接口

---

## 附录

### A. 相关文档

- [数据库设计](./DATABASE_DESIGN.md)
- [API设计](./API_DESIGN.md)
- [优化后的表设计](../OPTIMIZED_DESIGN.md)
- [数据导入设计](../DATA_IMPORT_DESIGN.md)

### B. 术语表

| 术语 | 说明 |
|-----|------|
| 概念 | 股票所属的板块/主题，如"人工智能"、"新能源" |
| 指标 | 交易数据类型，如TTV、EEE |
| 排名 | 股票在概念中按交易量的排序位置 |
| 前缀 | 股票代码前的交易所标识，如SH、SZ |
