# æ‰¹é‡å¯¼å…¥å·¥å…·ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

`batch_import.py` æ˜¯ä¸“é—¨ä¸ºå¤„ç†**å¤§å‹æ··åˆæ—¥æœŸæ–‡ä»¶**è®¾è®¡çš„æ‰¹é‡å¯¼å…¥å·¥å…·ã€‚å®ƒèƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ä¸­çš„ä¸åŒæ—¥æœŸï¼Œå¹¶é€šè¿‡å¤šè¿›ç¨‹å¹¶è¡Œå¤„ç†æ¥æé«˜å¯¼å…¥æ•ˆç‡ã€‚

### ä¸»è¦ç‰¹æ€§

- ğŸ”„ **è‡ªåŠ¨æ—¥æœŸåˆ†ç»„**ï¼šè‡ªåŠ¨æ‰«æå¹¶æŒ‰æ—¥æœŸåˆ†ç»„æ•°æ®
- âš¡ **å¤šè¿›ç¨‹å¹¶è¡Œ**ï¼šæ”¯æŒå¤šè¿›ç¨‹å¹¶è¡Œå¯¼å…¥ï¼Œæå‡æ•ˆç‡
- ğŸ“Š **è¿›åº¦å¯è§†åŒ–**ï¼šå®æ—¶è¿›åº¦æ¡æ˜¾ç¤º
- ğŸ’¾ **æ–­ç‚¹ç»­ä¼ **ï¼šä¸­æ–­åå¯ä»ä¸Šæ¬¡ä½ç½®ç»§ç»­
- ğŸ“… **æ—¥æœŸèŒƒå›´è¿‡æ»¤**ï¼šæ”¯æŒæŒ‡å®šå¯¼å…¥æ—¥æœŸèŒƒå›´
- ğŸ” **æ™ºèƒ½ç¼–ç æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç¼–ç ï¼ˆUTF-8/GBKï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºç¡€ç”¨æ³•

```bash
# å¯¼å…¥æ•´ä¸ªæ–‡ä»¶ï¼ˆé»˜è®¤4ä¸ªè¿›ç¨‹ï¼‰
python scripts/batch_import.py /path/to/EEE.txt --metric-code EEE

# ç¤ºä¾‹ï¼šå¯¼å…¥ä½ çš„æ–‡ä»¶
python scripts/batch_import.py /Users/peakom/Documents/work/æ•°æ®å¤„ç†/EEE.txt --metric-code EEE
```

### å¸¸ç”¨å‚æ•°

```bash
# è°ƒæ•´å¹¶è¡Œè¿›ç¨‹æ•°ï¼ˆæ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´ï¼‰
python scripts/batch_import.py file.txt --metric-code EEE --parallel 8

# ä»ä¸Šæ¬¡ä¸­æ–­å¤„ç»§ç»­ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰
python scripts/batch_import.py file.txt --metric-code EEE --resume

# åªå¯¼å…¥ç‰¹å®šæ—¥æœŸèŒƒå›´
python scripts/batch_import.py file.txt --metric-code EEE \
    --start-date 2024-01-01 \
    --end-date 2024-12-31
```

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡å¯¼å…¥å¤§æ–‡ä»¶

å½“ä½ æœ‰ä¸€ä¸ªåŒ…å«585ä¸ªæ—¥æœŸã€300ä¸‡æ¡æ•°æ®çš„æ–‡ä»¶æ—¶ï¼š

```bash
python scripts/batch_import.py /Users/peakom/Documents/work/æ•°æ®å¤„ç†/EEE.txt \
    --metric-code EEE \
    --parallel 8
```

é¢„æœŸè¾“å‡ºï¼š
```
å¼€å§‹æ‰«ææ–‡ä»¶: /Users/peakom/Documents/work/æ•°æ®å¤„ç†/EEE.txt
æ‰«ææ–‡ä»¶: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3078302/3078302 [00:05<00:00, 615660.40it/s]
æ‰«æå®Œæˆ: 585ä¸ªæ—¥æœŸ, 3078302æ¡æ•°æ®

============================================================
ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:
  æ€»æ—¥æœŸæ•°: 585
  æ€»æ•°æ®é‡: 3078302
  å·²å¤„ç†: 0
  å¤±è´¥: 0
============================================================

å‡†å¤‡å¤„ç† 585 ä¸ªæ—¥æœŸï¼Œä½¿ç”¨ 8 ä¸ªè¿›ç¨‹
å¯¼å…¥è¿›åº¦: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 585/585 [15:23<00:00, 1.58s/it]

============================================================
âœ… å¯¼å…¥å®Œæˆ:
  æˆåŠŸ: 585/585
  å¤±è´¥: 0
  è€—æ—¶: 0:15:23
============================================================
```

### åœºæ™¯2ï¼šä¸­æ–­åç»§ç»­

å¦‚æœå¯¼å…¥è¿‡ç¨‹ä¸­æ–­ï¼ˆCtrl+Cæˆ–ç½‘ç»œä¸­æ–­ï¼‰ï¼š

```bash
# ç¬¬ä¸€æ¬¡è¿è¡Œè¢«ä¸­æ–­
python scripts/batch_import.py file.txt --metric-code EEE
^C
æ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œä¿å­˜è¿›åº¦...

# ç»§ç»­å¯¼å…¥ï¼ˆè‡ªåŠ¨ä»ä¸Šæ¬¡ä½ç½®å¼€å§‹ï¼‰
python scripts/batch_import.py file.txt --metric-code EEE --resume
```

è¾“å‡ºï¼š
```
============================================================
ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:
  æ€»æ—¥æœŸæ•°: 585
  æ€»æ•°æ®é‡: 3078302
  å·²å¤„ç†: 234  # å·²ç»å¤„ç†çš„æ—¥æœŸ
  å¤±è´¥: 2
  ç»§ç»­ä»: 2024-05-15
============================================================
```

### åœºæ™¯3ï¼šåªå¯¼å…¥æœ€æ–°æ•°æ®

å½“ä½ åªæƒ³å¯¼å…¥æœ€è¿‘ä¸€ä¸ªæœˆçš„æ•°æ®ï¼š

```bash
python scripts/batch_import.py file.txt --metric-code EEE \
    --start-date 2025-10-01 \
    --end-date 2025-11-10
```

### åœºæ™¯4ï¼šå¤„ç†å¯¼å…¥å¤±è´¥

å¦‚æœéƒ¨åˆ†æ—¥æœŸå¯¼å…¥å¤±è´¥ï¼š

```bash
python scripts/batch_import.py file.txt --metric-code EEE --resume
```

è¾“å‡ºä¼šæ˜¾ç¤ºå¤±è´¥çš„æ—¥æœŸï¼š
```
============================================================
âœ… å¯¼å…¥å®Œæˆ:
  æˆåŠŸ: 580/585
  å¤±è´¥: 5
  è€—æ—¶: 0:15:23

âŒ å¤±è´¥çš„æ—¥æœŸ:
    - 2024-03-15
    - 2024-06-20
    - 2024-09-10
    - 2024-11-05
    - 2024-12-25
============================================================
```

## âš™ï¸ å‚æ•°è¯¦è§£

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `file` | å¿…éœ€ | - | è¦å¯¼å…¥çš„æ–‡ä»¶è·¯å¾„ |
| `--metric-code` | å¿…éœ€ | - | æŒ‡æ ‡ä»£ç ï¼ˆå¦‚EEEã€AAAç­‰ï¼‰ |
| `--parallel` | å¯é€‰ | 4 | å¹¶è¡Œè¿›ç¨‹æ•°ï¼ˆ1-CPUæ ¸å¿ƒæ•°ï¼‰ |
| `--resume` | å¯é€‰ | False | ä»ä¸Šæ¬¡ä¸­æ–­å¤„ç»§ç»­ |
| `--start-date` | å¯é€‰ | - | å¼€å§‹æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ |
| `--end-date` | å¯é€‰ | - | ç»“æŸæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ |

## ğŸ”§ æ€§èƒ½è°ƒä¼˜

### å¹¶è¡Œè¿›ç¨‹æ•°é€‰æ‹©

```bash
# æŸ¥çœ‹CPUæ ¸å¿ƒæ•°
python -c "import multiprocessing; print(f'CPUæ ¸å¿ƒæ•°: {multiprocessing.cpu_count()}')"

# å»ºè®®è®¾ç½®
# - CPUæ ¸å¿ƒæ•° <= 4ï¼šä½¿ç”¨ 2-3 ä¸ªè¿›ç¨‹
# - CPUæ ¸å¿ƒæ•° 8ï¼šä½¿ç”¨ 4-6 ä¸ªè¿›ç¨‹
# - CPUæ ¸å¿ƒæ•° >= 16ï¼šä½¿ç”¨ 8-12 ä¸ªè¿›ç¨‹
```

### æ€§èƒ½åŸºå‡†

| æ•°æ®è§„æ¨¡ | è¿›ç¨‹æ•° | é¢„è®¡è€—æ—¶ |
|---------|--------|----------|
| 100ä¸ªæ—¥æœŸï¼Œ50ä¸‡æ¡ | 1 | ~5åˆ†é’Ÿ |
| 100ä¸ªæ—¥æœŸï¼Œ50ä¸‡æ¡ | 4 | ~2åˆ†é’Ÿ |
| 585ä¸ªæ—¥æœŸï¼Œ300ä¸‡æ¡ | 1 | ~60åˆ†é’Ÿ |
| 585ä¸ªæ—¥æœŸï¼Œ300ä¸‡æ¡ | 4 | ~20åˆ†é’Ÿ |
| 585ä¸ªæ—¥æœŸï¼Œ300ä¸‡æ¡ | 8 | ~15åˆ†é’Ÿ |

## ğŸ“ è¿›åº¦æ–‡ä»¶

å·¥å…·ä¼šè‡ªåŠ¨åœ¨ `/tmp/` ç›®å½•åˆ›å»ºè¿›åº¦æ–‡ä»¶ï¼š

```bash
/tmp/batch_import_EEE.json  # EEEæŒ‡æ ‡çš„è¿›åº¦æ–‡ä»¶
```

è¿›åº¦æ–‡ä»¶å†…å®¹ç¤ºä¾‹ï¼š
```json
{
  "file_path": "/path/to/EEE.txt",
  "file_hash": "a1b2c3d4...",
  "total_dates": 585,
  "processed_dates": ["2024-01-01", "2024-01-02", ...],
  "failed_dates": ["2024-03-15"],
  "start_time": "2024-11-25T10:00:00",
  "last_update": "2024-11-25T10:15:23"
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å†…å­˜ä½¿ç”¨**ï¼šæ‰«æé˜¶æ®µä¼šå°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿå†…å­˜
2. **ç£ç›˜ç©ºé—´**ï¼šä¼šåœ¨ `/tmp` åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´
3. **æ•°æ®åº“è¿æ¥**ï¼šæ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹è¿æ¥æ•°æ®åº“ï¼Œæ³¨æ„æ•°æ®åº“è¿æ¥æ•°é™åˆ¶
4. **ä¸­æ–­å¤„ç†**ï¼šä½¿ç”¨ Ctrl+C ä¼˜é›…ä¸­æ–­ï¼Œä¼šè‡ªåŠ¨ä¿å­˜è¿›åº¦

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šç¼–ç é”™è¯¯

```
é”™è¯¯: æ— æ³•è§£ææ–‡ä»¶ç¼–ç 
```

è§£å†³ï¼šç¡®ä¿æ–‡ä»¶æ˜¯UTF-8æˆ–GBKç¼–ç 

### é—®é¢˜2ï¼šæ•°æ®åº“è¿æ¥è¶…é™

```
é”™è¯¯: too many connections
```

è§£å†³ï¼šå‡å°‘å¹¶è¡Œè¿›ç¨‹æ•°
```bash
python scripts/batch_import.py file.txt --metric-code EEE --parallel 2
```

### é—®é¢˜3ï¼šå†…å­˜ä¸è¶³

å¯¹äºè¶…å¤§æ–‡ä»¶ï¼ˆ>1GBï¼‰ï¼Œå»ºè®®ï¼š
1. å…ˆæ‹†åˆ†æ–‡ä»¶
2. æˆ–å‡å°‘å¹¶è¡Œè¿›ç¨‹æ•°

## ğŸ“ˆ æœ€ä½³å®è·µ

1. **é¦–æ¬¡å¯¼å…¥**ï¼šä½¿ç”¨è¾ƒå°‘è¿›ç¨‹æ•°æµ‹è¯•
   ```bash
   python scripts/batch_import.py file.txt --metric-code EEE --parallel 2
   ```

2. **æ­£å¼å¯¼å…¥**ï¼šæ ¹æ®æµ‹è¯•ç»“æœè°ƒæ•´
   ```bash
   python scripts/batch_import.py file.txt --metric-code EEE --parallel 8
   ```

3. **å¢é‡æ›´æ–°**ï¼šä½¿ç”¨æ—¥æœŸèŒƒå›´
   ```bash
   python scripts/batch_import.py file.txt --metric-code EEE \
       --start-date 2025-11-01
   ```

4. **ç›‘æ§è¿›åº¦**ï¼šæŸ¥çœ‹è¿›åº¦æ–‡ä»¶
   ```bash
   watch -n 1 'cat /tmp/batch_import_EEE.json | python -m json.tool'
   ```

## ğŸ¯ éªŒè¯å¯¼å…¥ç»“æœ

å¯¼å…¥å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹SQLéªŒè¯ï¼š

```sql
-- æŸ¥çœ‹å¯¼å…¥çš„æ—¥æœŸèŒƒå›´
SELECT
    MIN(trade_date) as start_date,
    MAX(trade_date) as end_date,
    COUNT(DISTINCT trade_date) as date_count,
    COUNT(*) as total_records
FROM concept_stock_daily_rank
WHERE metric_code = 'EEE';

-- æŸ¥çœ‹æ¯æ—¥æ•°æ®é‡
SELECT
    trade_date,
    COUNT(*) as record_count
FROM concept_stock_daily_rank
WHERE metric_code = 'EEE'
GROUP BY trade_date
ORDER BY trade_date DESC
LIMIT 10;

-- æŸ¥çœ‹æ±‡æ€»æ•°æ®
SELECT
    trade_date,
    COUNT(DISTINCT concept_id) as concept_count,
    SUM(stock_count) as total_stocks
FROM concept_daily_summary
WHERE metric_code = 'EEE'
GROUP BY trade_date
ORDER BY trade_date DESC
LIMIT 10;
```

## ğŸ“ æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ—¥å¿—æ–‡ä»¶è¾“å‡º
2. è¿›åº¦æ–‡ä»¶çŠ¶æ€
3. æ•°æ®åº“è¿æ¥çŠ¶æ€
4. ç³»ç»Ÿèµ„æºï¼ˆå†…å­˜ã€ç£ç›˜ï¼‰

---

*æ‰¹é‡å¯¼å…¥å·¥å…· v1.0 - ä¸“ä¸ºå¤§æ•°æ®æ–‡ä»¶ä¼˜åŒ–*