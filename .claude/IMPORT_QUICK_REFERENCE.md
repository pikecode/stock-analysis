# æ•°æ®å¯¼å…¥å¿«é€Ÿå‚è€ƒæŒ‡å—

**ç”¨é€”**ï¼šå¿«é€ŸæŸ¥é˜…å¯¼å…¥ç›¸å…³çš„æ ¸å¿ƒæ¦‚å¿µå’Œæ“ä½œæ­¥éª¤

---

## ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ

### 1ï¸âƒ£ CSV æ–‡ä»¶ï¼ˆè‚¡ç¥¨-æ¦‚å¿µå…³ç³»ï¼‰

| å±æ€§ | å€¼ |
|------|-----|
| **æ›´æ–°é¢‘ç‡** | ä¸å®šæ—¶ï¼ˆä¸€æ¬¡æ€§æˆ–å®šæœŸï¼‰ |
| **æ•°æ®è¯­ä¹‰** | è‚¡ç¥¨ â†” æ¦‚å¿µ çš„å¤šå¯¹å¤šæ˜ å°„å…³ç³» |
| **æ ¼å¼** | CSVï¼ˆé€—å·åˆ†éš”ï¼‰ |
| **å…³é”®åˆ—** | è‚¡ç¥¨ä»£ç , è‚¡ç¥¨åç§°, æ¦‚å¿µ |
| **ç‰¹ç‚¹** | åŒä¸€è‚¡ç¥¨å¯å¤šè¡Œï¼ˆæ¯è¡Œä¸€ä¸ªæ¦‚å¿µï¼‰ |
| **è®¡ç®—éœ€æ±‚** | âŒ æ— ï¼ˆä»…å­˜å‚¨æ˜ å°„å…³ç³»ï¼‰ |

**æ ·æœ¬æ•°æ®**:
```csv
è‚¡ç¥¨ä»£ç ,è‚¡ç¥¨åç§°,æ¦‚å¿µ
127111,é‡‘å¨è½¬å€º,é£Ÿå“é¥®æ–™
127111,é‡‘å¨è½¬å€º,ç¦å»ºæ¿å—
113698,å‡¯ä¼—è½¬å€º,æ±½è½¦é›¶éƒ¨ä»¶
```

### 2ï¸âƒ£ TXT æ–‡ä»¶ï¼ˆæ—¥æœŸç‰¹å®šæŒ‡æ ‡æ•°æ®ï¼‰

| å±æ€§ | å€¼ |
|------|-----|
| **æ›´æ–°é¢‘ç‡** | å‡ ä¹æ¯ä¸ªäº¤æ˜“æ—¥ï¼ˆå¦‚æ¯å¤©å¯¼å…¥ä¸€æ¬¡ï¼‰ |
| **æ•°æ®è¯­ä¹‰** | ç‰¹å®šæ—¥æœŸçš„è‚¡ç¥¨æŒ‡æ ‡æ•°æ® |
| **æ ¼å¼** | TXTï¼ˆTabæˆ–ç©ºæ ¼åˆ†éš”ï¼‰ |
| **å…³é”®åˆ—** | è‚¡ç¥¨ä»£ç (å«å‰ç¼€), æ—¥æœŸ, æŒ‡æ ‡å€¼ |
| **ä»£ç æ ¼å¼** | SH600000, SZ000001, BJ430047 |
| **è®¡ç®—éœ€æ±‚** | âœ… æ˜¯ï¼ˆæ’å + æ±‡æ€»ï¼‰ |

**æ ·æœ¬æ•°æ®**:
```
SH600000	2025-08-21	459400
SH600004	2025-08-21	375249
SZ000001	2025-08-21	987654
```

### 3ï¸âƒ£ æŒ‡æ ‡ç±»å‹

| æŒ‡æ ‡ä»£ç  | å«ä¹‰ | ä¾‹å­ |
|---------|------|------|
| EEE | è¡Œä¸šæ´»è·ƒåº¦ | EEE.txt, EEE_20250821.txt |
| TTV | äº¤æ˜“äº¤æ˜“é‡ | TTV.txt, TTV_20250821.txt |
| TOP | TOPæŒ‡æ ‡ | TOP.txt ç­‰ |
| è‡ªå®šä¹‰ | å…¶ä»–æŒ‡æ ‡ | å¯æ‰©å±• |

**å…³é”®ç‚¹**ï¼šæ¯ç§æŒ‡æ ‡ç‹¬ç«‹ç»´æŠ¤æ’åå’Œæ±‡æ€»æ•°æ®

---

## ğŸ”„ å¯¼å…¥æµç¨‹é€Ÿè§ˆ

### CSV å¯¼å…¥æµç¨‹ï¼ˆ5æ­¥ï¼‰

```
1. ä¸Šä¼ CSVæ–‡ä»¶
         â†“
2. æ–‡ä»¶æ ¼å¼æ£€éªŒï¼ˆåˆ—åã€ç¼–ç ï¼‰
         â†“
3. é€è¡Œè§£æ â†’ åˆ›å»º/æ›´æ–°è‚¡ç¥¨ã€æ¦‚å¿µã€æ˜ å°„å…³ç³»
         â†“
4. æ‰¹é‡æ•°æ®åº“æ“ä½œï¼ˆDELETEæ—§ + INSERTæ–°ï¼‰
         â†“
5. å®Œæˆ â†’ status: success, compute_status: pending (æ— è®¡ç®—)
```

**å…³é”®æ“ä½œ**ï¼š
```python
# ä¼ªä»£ç 
for each row in csv:
    stock_code, concept_name = parse(row)

# æ‰¹é‡æ›´æ–°æ˜ å°„å…³ç³»
DELETE FROM stock_concepts WHERE stock_code IN (...)
INSERT INTO stock_concepts (stock_code, concept_id) VALUES (...)
```

### TXT å¯¼å…¥æµç¨‹ï¼ˆ8æ­¥ï¼‰

```
1. ä¸Šä¼ TXTæ–‡ä»¶ + é€‰æ‹©æŒ‡æ ‡ç±»å‹ï¼ˆEEE/TTV/ç­‰ï¼‰
         â†“
2. æ–‡ä»¶æ ¼å¼æ£€éªŒï¼ˆç¼–ç ã€åˆ†éš”ç¬¦ï¼‰
         â†“
3. é€è¡Œè§£æ â†’ å‰¥ç¦»å‰ç¼€ã€è½¬æ¢æ—¥æœŸã€éªŒè¯å€¼
         â†“
4. é¢„åŠ è½½stock_conceptsæ˜ å°„ âš ï¸ é‡è¦ï¼šCSVå¿…é¡»å…ˆå¯¼å…¥
         â†“
5. æœ‰æ•ˆæ€§è¿‡æ»¤ â†’ ä»…ä¿ç•™åœ¨stock_conceptsä¸­çš„è‚¡ç¥¨
         â†“
6. æ‰¹é‡å¯¼å…¥åŸå§‹æ•°æ® â†’ stock_metric_data_raw
         â†“
7. è®¡ç®—æ’åå’Œæ±‡æ€» â†’ concept_stock_daily_rank + concept_daily_summary
         â†“
8. å®Œæˆ â†’ status: success, compute_status: completed
```

**å…³é”®çº¦æŸ**ï¼š
```
âš ï¸  CSV å¿…é¡»å…ˆå¯¼å…¥ï¼
    å¦‚æœCSVä¸­æ— è¯¥è‚¡ç¥¨çš„æ¦‚å¿µæ˜ å°„ï¼Œåˆ™TXTä¸­çš„æ•°æ®è¢«è¿‡æ»¤
```

---

## âœ… å¯¼å…¥å‰æ£€æŸ¥æ¸…å•

### ä¸Šä¼  CSV æ–‡ä»¶å‰

- [ ] ç¼–ç ä¸º UTF-8
- [ ] åˆ†éš”ç¬¦ä¸ºé€—å· (,)
- [ ] åŒ…å«åˆ—ï¼šè‚¡ç¥¨ä»£ç ã€è‚¡ç¥¨åç§°ã€æ¦‚å¿µ
- [ ] è‚¡ç¥¨ä»£ç ä¸ºæ•°å­—ï¼ˆä¸å«äº¤æ˜“æ‰€å‰ç¼€ï¼‰
- [ ] æ— ç©ºè¡Œæˆ–æ ¼å¼é”™è¯¯
- [ ] è¿è¡Œç¤ºä¾‹ï¼š`2025-08-22-01-31.csv`

### ä¸Šä¼  TXT æ–‡ä»¶å‰

- [ ] ç¼–ç ä¸º UTF-8
- [ ] åˆ†éš”ç¬¦ä¸º Tab (åˆ¶è¡¨ç¬¦) æˆ–ç©ºæ ¼
- [ ] è‡³å°‘3åˆ—ï¼šè‚¡ç¥¨ä»£ç ã€æ—¥æœŸã€å€¼
- [ ] è‚¡ç¥¨ä»£ç åŒ…å«äº¤æ˜“æ‰€å‰ç¼€ï¼ˆSH/SZ/BJï¼‰
- [ ] æ—¥æœŸæ ¼å¼ä¸º YYYY-MM-DD
- [ ] **ç¡®ä¿CSVä¸­æœ‰è¯¥è‚¡ç¥¨çš„æ¦‚å¿µæ˜ å°„** âš ï¸
- [ ] è¿è¡Œç¤ºä¾‹ï¼š`EEE.txt` æˆ– `TTV.txt`

---

## ğŸ“Š æ•°æ®æµå‘

```
ã€CSVå¯¼å…¥ã€‘
    â†“
    å‚¨å­˜åœ¨ï¼šstocks, concepts, stock_concepts
    â†“
    æ ¸å¿ƒï¼šstock_concepts è¡¨è®°å½•è‚¡ç¥¨-æ¦‚å¿µæ˜ å°„


ã€TXTå¯¼å…¥ã€‘
    â†“
    ç¬¬1æ­¥ï¼šå‚¨å­˜åŸå§‹æ•°æ® â†’ stock_metric_data_raw
    ç¬¬2æ­¥ï¼šæ ¹æ®stock_conceptsè¿‡æ»¤æœ‰æ•ˆæ•°æ®
    ç¬¬3æ­¥ï¼šè®¡ç®—æ’å â†’ concept_stock_daily_rank
    ç¬¬4æ­¥ï¼šè®¡ç®—æ±‡æ€» â†’ concept_daily_summary
    â†“
    æœ€ç»ˆï¼šç”¨æˆ·é€šè¿‡APIæŸ¥è¯¢concept_stock_daily_rankå’Œconcept_daily_summary
```

---

## ğŸ” é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šTXTå¯¼å…¥åæ— æ•°æ®æ˜¾ç¤º

**æ£€æŸ¥**ï¼š
```sql
-- 1. CSVæ•°æ®æ˜¯å¦å­˜åœ¨
SELECT COUNT(*) FROM stock_concepts;
-- é¢„æœŸï¼š> 0

-- 2. è¯¥è‚¡ç¥¨çš„æ¦‚å¿µæ˜ å°„æ˜¯å¦å­˜åœ¨
SELECT * FROM stock_concepts WHERE stock_code = '600000';
-- é¢„æœŸï¼šè‡³å°‘1è¡Œ

-- 3. TXTåŸå§‹æ•°æ®æ˜¯å¦å¯¼å…¥
SELECT COUNT(*) FROM stock_metric_data_raw
WHERE trade_date = '2025-08-21';
-- é¢„æœŸï¼š> 0
```

**è§£å†³**ï¼š
- âŒ å¦‚æœ stock_concepts ä¸ºç©º â†’ å…ˆå¯¼å…¥ CSV
- âŒ å¦‚æœç‰¹å®šè‚¡ç¥¨æ— æ¦‚å¿µæ˜ å°„ â†’ CSVä¸­ç¼ºå°‘è¯¥è‚¡ç¥¨ï¼Œè¡¥å……åé‡æ–°å¯¼å…¥CSV
- âŒ å¦‚æœ stock_metric_data_raw ä¸ºç©º â†’ TXTå¯¼å…¥å¤±è´¥ï¼Œæ£€æŸ¥é”™è¯¯æ—¥å¿—

### é—®é¢˜2ï¼šå¯¼å…¥æ˜¾ç¤º"invalid rows"è¿‡å¤š

**åŸå› **ï¼šTXTä¸­çš„è‚¡ç¥¨æœªåœ¨CSVä¸­å‡ºç°è¿‡

**è§£å†³**ï¼š
1. æ£€æŸ¥TXTä¸­çš„è‚¡ç¥¨ä»£ç ï¼ˆå»æ‰å‰ç¼€åï¼‰
2. åœ¨CSVä¸­è¡¥å……è¿™äº›è‚¡ç¥¨çš„æ¦‚å¿µæ˜ å°„
3. é‡æ–°å¯¼å…¥CSV
4. å†å¯¼å…¥TXT

### é—®é¢˜3ï¼šæ’åè®¡ç®—å¤±è´¥

**æ£€æŸ¥**ï¼š
```sql
-- æ£€æŸ¥import_batchesçš„é”™è¯¯ä¿¡æ¯
SELECT error_message FROM import_batches
WHERE status = 'failed'
ORDER BY created_at DESC
LIMIT 1;
```

**å¸¸è§åŸå› **ï¼š
- CSVæœªå¯¼å…¥
- TXTæ–‡ä»¶æ ¼å¼é”™è¯¯ï¼ˆæ—¥æœŸæ ¼å¼ã€åˆ†éš”ç¬¦ï¼‰
- æ•°æ®åº“è¿æ¥é—®é¢˜

---

## ğŸ’¾ å…³é”®è¡¨é€ŸæŸ¥

### æŸ¥è¯¢æœ€è¿‘å¯¼å…¥

```sql
SELECT id, file_name, file_type, status, compute_status,
       total_rows, success_rows, error_rows, created_at
FROM import_batches
ORDER BY created_at DESC
LIMIT 5;
```

### æŸ¥çœ‹æŸè‚¡ç¥¨çš„æ¦‚å¿µ

```sql
SELECT c.concept_name
FROM stock_concepts sc
JOIN concepts c ON sc.concept_id = c.id
WHERE sc.stock_code = '600000'
LIMIT 20;
```

### æŸ¥çœ‹æ’åæ•°æ®

```sql
-- æŸæ¦‚å¿µåœ¨æŸæ—¥æœŸçš„æ’åTop 10
SELECT rank, stock_code, trade_value
FROM concept_stock_daily_rank
WHERE concept_id = 10 AND trade_date = '2025-08-21'
ORDER BY rank ASC
LIMIT 10;
```

### æŸ¥çœ‹æ±‡æ€»æ•°æ®

```sql
-- æŸæ¦‚å¿µçš„æ—¥æ±‡æ€»ç»Ÿè®¡
SELECT trade_date, total_value, avg_value, max_value,
       stocks_total, stocks_with_data
FROM concept_daily_summary
WHERE concept_id = 10 AND trade_date = '2025-08-21';
```

---

## ğŸ“ˆ å¯¼å…¥æ€§èƒ½é¢„æœŸ

| æ“ä½œ | æ•°æ®é‡ | æ—¶é—´ |
|------|--------|------|
| CSVè§£æ | 10Kè¡Œ | <100ms |
| CSVå¯¼å…¥ | 1Kè‚¡ç¥¨+1Kæ¦‚å¿µ | <500ms |
| TXTè§£æ | 5Kè¡Œ | <50ms |
| TXTå¯¼å…¥ | 4Kæœ‰æ•ˆè¡Œ | <500ms |
| æ’åè®¡ç®— | 100ä¸ªæ¦‚å¿µ | <100ms |
| æ±‡æ€»è®¡ç®— | 100ä¸ªæ¦‚å¿µ | <50ms |
| **æ€»ä½“** | | **<1ç§’** |

---

## ğŸ” é‡è¦çº¦æŸ

### âš ï¸ å¿…é¡»éµå®ˆ

1. **å¯¼å…¥é¡ºåº**ï¼šCSV â†’ TXTï¼ˆä¸èƒ½é¢ å€’ï¼‰
2. **ä»£ç åŒ¹é…**ï¼šCSVä¸­çš„ä»£ç ï¼ˆæ— å‰ç¼€ï¼‰= TXTä»£ç ï¼ˆå»å‰ç¼€åï¼‰
3. **æ¦‚å¿µå…³è”**ï¼šTXTä¸­çš„è‚¡ç¥¨å¿…é¡»åœ¨CSVä¸­æœ‰æ¦‚å¿µæ˜ å°„
4. **æ—¥æœŸæ ¼å¼**ï¼šTXTä¸­å¿…é¡»æ˜¯ YYYY-MM-DD
5. **ç¼–ç æ ¼å¼**ï¼šéƒ½å¿…é¡»æ˜¯ UTF-8

### âœ… æœ€ä½³å®è·µ

1. å®šæœŸå¤‡ä»½å¯¼å…¥å‰çš„æ•°æ®
2. é€æ—¥å¯¼å…¥TXTï¼ˆä¾¿äºæ’æŸ¥å’Œå›æ»šï¼‰
3. ç›‘æ§ import_batches çš„çŠ¶æ€å’Œé”™è¯¯
4. å®šæœŸæ¸…ç†è¿‡æœŸçš„ä¸´æ—¶æ–‡ä»¶

---

## ğŸ“ å¿«é€Ÿé“¾æ¥

è¯¦ç»†æ–‡æ¡£ï¼š
- å®Œæ•´è®¾è®¡ï¼š`.spec-workflow/data-import-workflow.md`
- æ•°æ®åº“æ¶æ„ï¼š`.spec-workflow/database-schema.md`
- å¯¼å…¥åˆ†æï¼š`.claude/IMPORT_LOGIC_ANALYSIS.md`

---

**æœ€åæ›´æ–°**ï¼š2025-11-28
**ç‰ˆæœ¬**ï¼š1.0
